name: Build and Deploy to GKE

on:
  push:
    branches: "master"
  pull_request:
    branches: "master"
  workflow_dispatch:

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json
            worker/package-lock.json
      
      - name: Install Client Dependencies and Test
        run: |
          cd client
          npm ci
          npm test

      - name: Install Server Dependencies and Test
        run: |
          cd server
          npm ci
          npm test

      - name: Install Worker Dependencies and Test
        run: |
          cd worker
          npm ci
          npm test
      
  build-and-deploy:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/head/master'

    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auth with GC
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run:  gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and push client image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile.dev # Assuming you use a dev Dockerfile
          push: true
          tags: us-central1-docker.pkg.dev/micro-pilot-471618-g5/k8multicontainer/multi-client:latest

      - name: Build and push server image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: us-central1-docker.pkg.dev/micro-pilot-471618-g5/k8multicontainer/multi-server:latest

      - name: Build and push worker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker
          push: true
          tags: us-central1-docker.pkg.dev/micro-pilot-471618-g5/k8multicontainer/multi-worker:latest

      - name: Deploy to GKE
        run: |
          gcloud container clusters get-credentials multi-container-cluster --zone us-central1 --project micro-pilot-471618-g5
          kubectl apply -f k8s/
          kubectl rollout restart deployment/server-deployment
          kubectl rollout restart deployment/client-deployment
          kubectl rollout restart deployment/worker-deployment

#google managed SSL certs
#apiVersion: networking.gke.io/v1
#kind: ManagedCertificate
#metadata:
  #name: gke-managed-cert
#spec:
  #domains:
    #- your-app.com # <-- Replace with your domain name
#apply to the cluster
#update ingress manifest

#Production Grade:
#Linter
#Security Vulerbility Scanning
#Distinct Docker Tagging
#Staging vs Production, integration testing
#Notifications for failing jobs